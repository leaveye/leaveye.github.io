<!DOCTYPE html>
<html lang="chinese (simplified)">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>APT 返回 TypeError 的错误 | Happy Coding
</title>
  <link rel="canonical" href="/apt-reports-typeerror.html">



  <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="/theme/css/style.css">


<meta name="description" content="最近在为公司整理工作环境，部署 OMV 4 时，发现 apt update 指令会引发如下错误： Exception ignored in: <function WeakValueDictionary.__init__.<locals>.remove at 0x............> Traceback (most recent call last): File "/usr/lib/python3.5/weakref.py", line 117, in remove TypeError: 'NoneType' object is not callable Exception ignored in: <function WeakValueDictionary.__init__.<locals>.remove at …">
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1 class="title"><a href="">Happy Coding</a></h1>
          <ul class="list-inline">
            <li class="list-inline-item"><a href="https://chou.it" target="_blank">Lex Chow的博客</a></li>
            <li class="list-inline-item"><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
            <li class="list-inline-item"><a href="http://python.org/" target="_blank">Python.org</a></li>
            <li class="list-inline-item"><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>APT 返回 TypeError 的错误
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2018-06-22T09:43:00+08:00">
        <i class="fa fa-clock-o"></i>
        五 22 六月 2018
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="/category/linux.html">Linux</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="/author/levi-g.html">Levi G</a>      </li>
      <li class="list-inline-item">
        <i class="fa fa-files-o"></i>
        <a href="/tag/server.html">#server</a>,         <a href="/tag/install.html">#install</a>,         <a href="/tag/apt.html">#apt</a>      </li>
    </ul>
  </header>
  <div class="content">
    <p>最近在为公司整理工作环境，部署 OMV 4 时，发现 <code>apt update</code> 指令会引发如下错误：</p>
<div class="highlight"><pre><span></span>Exception ignored in: &lt;function WeakValueDictionary.__init__.&lt;locals&gt;.remove at 0x............&gt;
Traceback (most recent call last):
  File &quot;/usr/lib/python3.5/weakref.py&quot;, line 117, in remove
TypeError: &#39;NoneType&#39; object is not callable
Exception ignored in: &lt;function WeakValueDictionary.__init__.&lt;locals&gt;.remove at 0x............&gt;
Traceback (most recent call last):
  File &quot;/usr/lib/python3.5/weakref.py&quot;, line 117, in remove
TypeError: &#39;NoneType&#39; object is not callable
</pre></div>


<p>找了一下，根据 <a href="https://forum.openmediavault.org/index.php/Thread/19658-Upgrade-Debian-9-and-4-x/?postID=154150#post154150">OVM 的论坛回复</a>，应该是 python 的 <a href="https://bugs.python.org/issue29519">bug</a>，同时提供了 <a href="https://github.com/python/cpython/commit/9cd7e17640a49635d1c1f8c2989578a8fc2c1de6">fix</a> 。</p>
<p>具体方法就是修改 <code>/usr/lib/python3.5/weakref.py</code> 文件的 109 行和 117 行：</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -106,15 +106,15 @@ def __init__(*args, **kw):</span>
         self, *args = args
         if len(args) &gt; 1:
             raise TypeError(&#39;expected at most 1 arguments, got %d&#39; % len(args))
<span class="gd">-        def remove(wr, selfref=ref(self)):</span>
<span class="gi">+        def remove(wr, selfref=ref(self), _atomic_removal=_remove_dead_weakref):</span>
             self = selfref()
             if self is not None:
                 if self._iterating:
                     self._pending_removals.append(wr.key)
                 else:
                     # Atomic removal is necessary since this function
                     # can be called asynchronously by the GC
<span class="gd">-                    _remove_dead_weakref(d, wr.key)</span>
<span class="gi">+                    _atomic_removal(d, wr.key)</span>
         self._remove = remove
         # A list of keys to be removed
         self._pending_removals = []
</pre></div>
  </div>
</article>
<hr>
<div id="disqus_thread"></div>
<script>
  var disqus_config = function() {
    this.page.url = '/apt-reports-typeerror.html';
    this.page.identifier = 'apt-reports-typeerror';
  };
  (function() {
    var d = document;
    var s = d.createElement('script');
    s.src = '//blog-levi-g-info.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript class="text-muted">
  Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="/authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="/archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="/categories.html">Categories</a></li>
          <li class="list-inline-item"><a href="/tags.html">Tags</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a> / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>